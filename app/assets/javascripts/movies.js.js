// Generated by CoffeeScript 1.6.3
(function() {
  var makeComments, makeSubmitButtonHandler, moveComment, moveCommentIn, moveCommentOut, moveNewComment, randPos, timeout;

  jQuery(function() {
    var atts, movieURL, params;
    params = {
      allowScriptAccess: "always"
    };
    atts = {
      id: "myytplayer"
    };
    movieURL = "http://www.youtube.com/v/" + gon.movie_url + "?enablejsapi=1&playerapiid=ytplayer";
    return swfobject.embedSWF(movieURL, "ytapiplayer", "480", "360", "8", null, null, params, atts);
  });

  window.onYouTubeIframeAPIReady = function() {
    return window.player = new YT.Player('player', {
      height: '390',
      width: '640',
      videoId: gon.movie_url,
      events: {
        'onReady': onYouTubePlayerReady,
        'onStateChange': onytplayerStateChange
      }
    });
  };

  timeout = function(time) {
    return jQuery.Deferred(function(dfd) {
      return setTimeout(dfd.resolve, time);
    }).promise();
  };

  window.onYouTubePlayerReady = function(playerId) {
    window.ytplayer = document.getElementById("myytplayer");
    ytplayer.addEventListener("onStateChange", "onytplayerStateChange");
    return makeSubmitButtonHandler();
  };

  makeSubmitButtonHandler = function() {
    return jQuery('#comments-form div.submit input').click(function() {
      var commentedTime;
      commentedTime = Math.floor(ytplayer.getCurrentTime() * 1000);
      jQuery('#comment_commented_time').val(commentedTime);
      return moveNewComment();
    });
  };

  moveNewComment = function() {
    var newMessage;
    newMessage = jQuery('#comment_message').val();
    return moveComment(jQuery('<p>' + newMessage + '</p>').appendTo(jQuery('#comments')));
  };

  window.onytplayerStateChange = function(newState) {
    if (newState === 1 && (gon.comment_exists = true)) {
      if (window.stopMovie === true) {
        window.stopMovie = false;
        moveCommentOut(jQuery('#comments').children('p.onDisplay'));
      }
      return makeComments();
    } else {
      return window.stopMovie = true;
    }
  };

  makeComments = function() {
    return jQuery('#comments').children('p').map(function() {
      var comment, waitTime;
      comment = jQuery(this);
      waitTime = comment.attr('commented-time') - (ytplayer.getCurrentTime() * 1000);
      if (waitTime > 0) {
        return timeout(waitTime).then(function() {
          if (stopMovie === true) {
            return;
          }
          return moveComment(comment);
        });
      }
    });
  };

  moveComment = function(comment) {
    moveCommentIn(comment);
    return timeout(1500).then(function() {
      if (stopMovie === true) {
        return;
      }
      return moveCommentOut(comment);
    });
  };

  moveCommentIn = function(comment) {
    return comment.css({
      'display': 'block',
      'top': randPos()
    }).addClass('animated bounceInRight onDisplay');
  };

  randPos = function() {
    var randnum;
    randnum = Math.floor(Math.random() * 300);
    return randnum + 'px';
  };

  moveCommentOut = function(comment) {
    return comment.removeClass('bounceInRight onDisplay').addClass('bounceOutLeft');
  };

}).call(this);
